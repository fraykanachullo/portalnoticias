{% extends "base.html" %}
{% block title %}Noticias 2025{% endblock %}
{% block content %}

<style>
/* ========================= */
/* NAV CATEGOR√çAS */
/* ========================= */
.category-nav {
    white-space: nowrap;
    overflow-x: auto;
    padding-bottom: 8px;
    border-bottom: 1px solid #ddd;
    margin-bottom: 16px;
}
.category-nav a {
    display: inline-block;
    margin-right: 16px;
    font-weight: 600;
    color: #444;
    text-decoration: none;
    padding-bottom: 6px;
    font-size: 15px;
}
.category-nav a:hover {
    color: #e40326;
}
.category-nav a.active {
    color: #e40326;
    border-bottom: 3px solid #e40326;
}

/* ========================= */
/* PORTADA PRINCIPAL */
/* ========================= */
.main-feature {
    height: 430px;
    background-size: cover;
    background-position: center;
    border-radius: 16px;
    position: relative;
    color: white;
    overflow: hidden;
}
.main-feature .overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.15),
        rgba(0,0,0,0.9)
    );
}
.main-feature .text-area {
    position: absolute;
    bottom: 25px;
    left: 25px;
    right: 25px;
}

/* ========================= */
/* PORTADAS SECUNDARIAS */
/* ========================= */
.feature-small {
    height: 210px;
    background-size: cover;
    background-position: center;
    border-radius: 14px;
    position: relative;
    color: white;
    overflow: hidden;
}
.feature-small .overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.25),
        rgba(0,0,0,0.9)
    );
}
.feature-small .text-area {
    position: absolute;
    bottom: 12px;
    left: 15px;
}

/* ========================= */
/* CARDS NOTICIAS */
/* ========================= */
.card-news {
    border: none;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.card-news img {
    height: 180px;
    width: 100%;
    object-fit: cover;
}

/* ========================= */
/* SIDEBAR */
/* ========================= */
.sidebar-card {
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.sidebar-item-title {
    font-size: 0.9rem;
    font-weight: 500;
}

/* ========================= */
/* FALLBACK DE IMAGEN */
/* ========================= */
.fallback-img {
    background-color: #ddd;
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
}

/* ========================= */
/* PAGINACI√ìN */
/* ========================= */
.pagination .page-link {
    color: #e40326;
}
.pagination .page-item.active .page-link {
    background-color: #e40326;
    border-color: #e40326;
}
</style>

<!-- ===================================================== -->
<!-- üîù CABECERA: CATEGOR√çAS + BUSCADOR + RESUMEN STATS -->
<!-- ===================================================== -->

<div class="row align-items-center mb-3">

    <div class="col-md-8">
        <div class="category-nav">

            <!-- √öltimas noticias (sin filtro categor√≠a) -->
            <a href="/"
               class="{{ 'active' if not request.args.get('categoria') else '' }}">
                √öltimas noticias
            </a>

            <!-- Categor√≠as fijas ‚Äúpremium‚Äù -->
            <a href="/?categoria=Deportes"
               class="{{ 'active' if request.args.get('categoria')=='Deportes' else '' }}">
                Deportes
            </a>

            <a href="/?categoria=Pol√≠tica"
               class="{{ 'active' if request.args.get('categoria')=='Pol√≠tica' else '' }}">
                Pol√≠tica
            </a>

            <a href="/?categoria=Mundo"
               class="{{ 'active' if request.args.get('categoria')=='Mundo' else '' }}">
                Mundo
            </a>

            <a href="/?categoria=Econom√≠a"
               class="{{ 'active' if request.args.get('categoria')=='Econom√≠a' else '' }}">
                Econom√≠a
            </a>

            <a href="/?categoria=Espect√°culos"
               class="{{ 'active' if request.args.get('categoria')=='Espect√°culos' else '' }}">
                Espect√°culos
            </a>

            <!-- Categor√≠as din√°micas desde BD (evitamos duplicar las fijas) -->
            {% for c in categorias %}
                {% if c not in ['Deportes','Pol√≠tica','Mundo','Econom√≠a','Espect√°culos'] %}
                    <a href="/?categoria={{ c }}"
                       class="{{ 'active' if request.args.get('categoria') == c else '' }}">
                        {{ c }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Buscador -->
    <div class="col-md-4 mt-3 mt-md-0">
        <form class="d-flex" method="get" action="/">
            <input type="hidden" name="categoria" value="{{ request.args.get('categoria','') }}">
            <input type="text"
                   name="q"
                   class="form-control form-control-sm me-2"
                   placeholder="Buscar noticia..."
                   value="{{ request.args.get('q','') }}">
            <button class="btn btn-sm btn-danger" type="submit">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </form>
    </div>
</div>

<!-- Resumen chiquito -->
{% if stats %}
<p class="text-muted small mb-3">
    Mostrando <b>{{ total_noticias_filtradas }}</b> noticias ¬∑
    <b>{{ stats.total_fuentes }}</b> fuentes ¬∑
    <b>{{ stats.total_categorias }}</b> categor√≠as
</p>
{% endif %}


<!-- ===================================================== -->
<!-- üì∞ PORTADA PRINCIPAL + SECUNDARIAS -->
<!-- ===================================================== -->

{% if noticias and noticias|length > 0 %}
<div class="row mb-4">

    <!-- PORTADA PRINCIPAL -->
    <div class="col-lg-8 mb-3 mb-lg-0">

        {% set portada = noticias[0] %}
        {% set portada_img = portada.url_imagen if portada.url_imagen else "https://via.placeholder.com/800x450?text=Sin+Imagen" %}

        <a href="{{ portada.url_noticia }}" target="_blank">
            <div class="main-feature" style="background-image:url('{{ portada_img }}')">

                <div class="overlay"></div>

                <div class="text-area">
                    <span class="badge bg-danger px-3 py-1">{{ portada.fuente }}</span>
                    <h2 class="fw-bold mt-2">{{ portada.titulo }}</h2>
                    {% if portada.categoria %}
                        <span class="badge bg-light text-dark mt-2">{{ portada.categoria }}</span>
                    {% endif %}
                </div>
            </div>
        </a>
    </div>

    <!-- PORTADAS SECUNDARIAS -->
    <div class="col-lg-4">

        {% for n in noticias[1:3] %}
            {% set img = n.url_imagen if n.url_imagen else "https://via.placeholder.com/800x450?text=Sin+Imagen" %}
            <a href="{{ n.url_noticia }}" target="_blank">
                <div class="feature-small mb-3" style="background-image:url('{{ img }}')">
                    <div class="overlay"></div>
                    <div class="text-area">
                        <span class="badge bg-dark">{{ n.fuente }}</span>
                        <h6 class="fw-bold mt-2">{{ n.titulo }}</h6>
                    </div>
                </div>
            </a>
        {% endfor %}

    </div>

</div>
{% endif %}


<!-- ===================================================== -->
<!-- üß± CUERPO: GRID + SIDEBAR -->
<!-- ===================================================== -->

<div class="row">

    <!-- ========= GRID DE NOTICIAS ========= -->
    <div class="col-lg-9">

        <h4 class="fw-bold mb-3">
            {% if request.args.get('categoria') %}
                {{ request.args.get('categoria') }} ¬∑ √öltimas noticias
            {% else %}
                √öltimas Noticias
            {% endif %}
        </h4>

        <div class="row">
            {% for n in noticias[3:15] %}
                {% set img = n.url_imagen if n.url_imagen else "https://via.placeholder.com/800x450?text=Sin+Imagen" %}
                <div class="col-md-4 mb-4">
                    <div class="card-news">
                        <img src="{{ img }}">
                        <div class="p-3">
                            <small class="text-muted">
                                {{ n.fuente }}
                                {% if n.categoria %} ¬∑ {{ n.categoria }}{% endif %}
                            </small>
                            <h6 class="fw-bold mt-1">{{ n.titulo }}</h6>
                            <a href="{{ n.url_noticia }}" target="_blank"
                               class="btn btn-danger btn-sm mt-2">Leer m√°s</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if total_paginas and total_paginas > 1 %}
{% set current_page = request.args.get('page', 1) | int %}

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-3">

        {# Bot√≥n ¬´ Anterior #}
        <li class="page-item {% if current_page <= 1 %}disabled{% endif %}">
            <a class="page-link"
               href="/?page={{ current_page - 1 if current_page > 1 else 1 }}{% if request.args.get('categoria') %}&categoria={{ request.args.get('categoria') }}{% endif %}{% if request.args.get('q') %}&q={{ request.args.get('q') }}{% endif %}">
                ¬´
            </a>
        </li>

        {# Siempre mostrar la p√°gina 1 #}
        <li class="page-item {% if current_page == 1 %}active{% endif %}">
            <a class="page-link"
               href="/?page=1{% if request.args.get('categoria') %}&categoria={{ request.args.get('categoria') }}{% endif %}{% if request.args.get('q') %}&q={{ request.args.get('q') }}{% endif %}">
                1
            </a>
        </li>

        {# Ellipsis si estamos lejos del inicio #}
        {% if current_page > 4 %}
        <li class="page-item disabled">
            <span class="page-link">‚Ä¶</span>
        </li>
        {% endif %}

        {# P√°ginas alrededor de la actual (ej: current-2 ‚Ä¶ current+2) #}
        {% set start = 2 if current_page - 2 < 2 else current_page - 2 %}
        {% set end = (total_paginas - 1) if current_page + 2 > (total_paginas - 1) else current_page + 2 %}

        {% for p in range(start, end + 1) %}
        <li class="page-item {% if p == current_page %}active{% endif %}">
            <a class="page-link"
               href="/?page={{ p }}{% if request.args.get('categoria') %}&categoria={{ request.args.get('categoria') }}{% endif %}{% if request.args.get('q') %}&q={{ request.args.get('q') }}{% endif %}">
                {{ p }}
            </a>
        </li>
        {% endfor %}

        {# Ellipsis si estamos lejos del final #}
        {% if current_page < total_paginas - 3 %}
        <li class="page-item disabled">
            <span class="page-link">‚Ä¶</span>
        </li>
        {% endif %}

        {# Siempre mostrar la √∫ltima p√°gina (si hay m√°s de 1) #}
        {% if total_paginas > 1 %}
        <li class="page-item {% if current_page == total_paginas %}active{% endif %}">
            <a class="page-link"
               href="/?page={{ total_paginas }}{% if request.args.get('categoria') %}&categoria={{ request.args.get('categoria') }}{% endif %}{% if request.args.get('q') %}&q={{ request.args.get('q') }}{% endif %}">
                {{ total_paginas }}
            </a>
        </li>
        {% endif %}

        {# Bot√≥n Siguiente ¬ª #}
        <li class="page-item {% if current_page >= total_paginas %}disabled{% endif %}">
            <a class="page-link"
               href="/?page={{ current_page + 1 if current_page < total_paginas else total_paginas }}{% if request.args.get('categoria') %}&categoria={{ request.args.get('categoria') }}{% endif %}{% if request.args.get('q') %}&q={{ request.args.get('q') }}{% endif %}">
                ¬ª
            </a>
        </li>

    </ul>
</nav>
{% endif %}

    </div>


    <!-- ========= SIDEBAR: TENDENCIAS + FACEBOOK ========= -->
    <div class="col-lg-3">

        <!-- Tendencias -->
        <div class="card sidebar-card mb-4">
            <div class="card-body">
                <h5 class="fw-bold mb-3">
                    <i class="fa-solid fa-fire text-danger"></i> Tendencias
                </h5>

                {% set tendencias = noticias[:5] if noticias else [] %}

                {% if tendencias %}
                    {% for t in tendencias %}
                        <div class="mb-3">
                            <a href="{{ t.url_noticia }}" target="_blank"
                               class="text-decoration-none text-dark">
                                <div class="sidebar-item-title">
                                    {{ t.titulo }}
                                </div>
                            </a>
                            <small class="text-muted">{{ t.fuente }}</small>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted small mb-0">Sin datos de tendencias.</p>
                {% endif %}
            </div>
        </div>

        <!-- Top Facebook -->
        <div class="card sidebar-card">
            <div class="card-body">
                <h5 class="fw-bold mb-3">
                    <i class="fa-brands fa-facebook text-primary"></i> Top Facebook
                </h5>

                {% if publicaciones_fb and publicaciones_fb|length > 0 %}
                    {% for p in publicaciones_fb %}
                        <div class="d-flex mb-3">
                            <img src="{{ p.url_imagen if p.url_imagen else 'https://via.placeholder.com/80x60?text=FB' }}"
                                 style="width:80px;height:60px;object-fit:cover;border-radius:6px;margin-right:10px;">
                            <div>
                                <div class="sidebar-item-title">
                                    <a href="{{ p.url }}" target="_blank"
                                       class="text-decoration-none text-dark">
                                        {{ p.titulo }}
                                    </a>
                                </div>
                                {% if p.fecha_publicacion %}
                                    <small class="text-muted">
                                        {{ p.fecha_publicacion.strftime('%d/%m/%Y') if p.fecha_publicacion.__class__.__name__ == 'datetime' else p.fecha_publicacion }}
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted small mb-0">Sin publicaciones recientes.</p>
                {% endif %}
            </div>
        </div>

    </div>

</div>

<!-- üîÑ AUTO-REFRESH CADA 5 MIN -->
<script>
setTimeout(function () {
    location.reload();
}, 5 * 60 * 1000);
</script>

{% endblock %}
